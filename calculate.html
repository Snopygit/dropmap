<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Busroute ziehen und Drop berechnen</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    body.no-scroll { overflow: hidden; }

    /* Header */
    .header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: absolute;
      top: 0;
      left: 0;
      padding: 10px 20px;
      background: #111;
      z-index: 1000;
    }
    .header a {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: white;
    }
    .header img.logo {
      width: 32px;
      height: 32px;
      border-radius: 4px;
    }
    .header .home-text {
      font-weight: bold;
      font-size: 18px;
      margin-left: 8px;
    }
    #userBlock {
      position: relative;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    #userAvatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }
    #userName {
      font-size: 16px;
    }
    #logoutMenu {
      display: none;
      position: absolute;
      top: 110%;
      right: 0;
      background: #222;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      overflow: hidden;
      z-index: 1001;
    }
    #logoutMenu button {
      display: block;
      width: 100%;
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    #logoutMenu button:hover {
      background: #c32;
    }

    /* Title */
    h2 {
      margin-top: 60px;
      margin-bottom: 20px;
    }

    /* Map Container */
    #mapContainer {
      position: relative;
      width: 900px;
      height: 900px;
      max-width: 95vw;
      max-height: 95vh;
      overflow: hidden;
      margin-bottom: 20px;
    }
    canvas {
      display: block;
      cursor: grab;
      background: #222;
    }

    /* Controls below map */
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 40px;
    }
    .controls button {
      padding: 10px 20px;
      border-radius: 30px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    /* Popup / Overlay (not used here but kept) */
    .overlay { display: none; }
    .popup { display: none; }
  </style>
</head>
<body>
  <div class="header">
    <a href="index.html">
      <img class="logo" src="fortnite-dropmap/assets/dropmap.png" alt="Dropmap">
      <span class="home-text">Home</span>
    </a>
    <div id="userBlock">
      <img id="userAvatar" src="fortnite-dropmap/assets/discord.png" alt="Avatar">
      <span id="userName">Gast</span>
      <div id="logoutMenu"><button onclick="logout()">Log out</button></div>
    </div>
  </div>

  <h2>Busroute ziehen und Drop berechnen</h2>

  <div id="mapContainer">
    <canvas id="mapCanvas" width="900" height="900"></canvas>
  </div>

  <div class="controls">
    <button onclick="calculateDrops()">ðŸŽ¯Â FIND BEST DROP</button>
    <button onclick="resetRoute()">ðŸ”„ Reset</button>
  </div>

  <script>
    // User block logic
    document.addEventListener('DOMContentLoaded', () => {
      const user = JSON.parse(localStorage.getItem('user')||'{}');
      if (user.username) {
        document.getElementById('userName').textContent = user.username;
        document.getElementById('userAvatar').src = user.avatarUrl;
      }
      const block = document.getElementById('userBlock');
      const menu = document.getElementById('logoutMenu');
      block.addEventListener('mouseenter', () => menu.style.display = 'block');
      block.addEventListener('mouseleave', () => menu.style.display = 'none');
    });
    function logout(){ localStorage.removeItem('user'); window.location='index.html'; }

    // Map + drop logic
    const canvas = document.getElementById('mapCanvas'), ctx = canvas.getContext('2d');
    const img = new Image(); img.src='fortnite-dropmap/assets/map.png'; img.onerror=()=>alert('Fehler: Karte konnte nicht geladen werden.');

    const drops = JSON.parse(localStorage.getItem('dropmaps')||'[]');
    const idx = +localStorage.getItem('editingDropmapIndex');
    const dropmap = drops[idx]||{points:[]}; dropmap.points=dropmap.points||[];

    const route = [{x:150,y:150},{x:750,y:750}];
    let bestLine=null, scale=1, ox=0, oy=0, dragStart=null, dragType=null, offX,offY;

    img.onload = draw;

    canvas.addEventListener('wheel', e=>{
      e.preventDefault();
      const d=e.deltaY>0?-0.1:0.1;
      const mx=(e.offsetX-ox)/scale, my=(e.offsetY-oy)/scale;
      scale=Math.min(Math.max(0.5,scale+d),3);
      ox=e.offsetX-mx*scale; oy=e.offsetY-my*scale;
      draw();
    });

    canvas.addEventListener('mousedown', e=>{
      const x=(e.offsetX-ox)/scale, y=(e.offsetY-oy)/scale;
      dragStart={x:e.clientX,y:e.clientY}; dragType='pan'; offX=e.clientX-ox; offY=e.clientY-oy;
      route.forEach((p,i)=>{ if(Math.hypot(p.x-x,p.y-y)<12){ dragType=i; offX=p.x-x; offY=p.y-y; }});
    });
    canvas.addEventListener('mousemove', e=>{
      if(!dragStart) return;
      const dx=e.clientX-dragStart.x, dy=e.clientY-dragStart.y;
      if(dragType==='pan'){
        ox=e.clientX-offX; oy=e.clientY-offY;
      } else {
        const rect=canvas.getBoundingClientRect();
        const nx=(e.clientX-rect.left-ox)/scale, ny=(e.clientY-rect.top-oy)/scale;
        route[dragType]={x:nx+offX,y:ny+offY};
      }
      dragStart={x:e.clientX,y:e.clientY};
      draw();
    });
    canvas.addEventListener('mouseup',()=>dragStart=null);

    function drawArrowLine(s,e){ const dx=e.x-s.x, dy=e.y-s.y, len=Math.hypot(dx,dy), steps=Math.floor(len/30), ang=Math.atan2(dy,dx);
      for(let i=0;i<steps;i++){ const x=s.x+dx*(i/steps), y=s.y+dy*(i/steps);
        ctx.save(); ctx.translate(x,y); ctx.rotate(ang);
        ctx.beginPath(); ctx.moveTo(-5,-5); ctx.lineTo(5,0); ctx.lineTo(-5,5); ctx.closePath(); ctx.fill(); ctx.restore();
      }}

    function draw(){
      canvas.width=900; canvas.height=900;
      ctx.setTransform(scale,0,0,scale,ox,oy);
      ctx.clearRect(0,0,900,900);
      ctx.drawImage(img,0,0,900,900);
      ctx.fillStyle='#FFF'; drawArrowLine(route[0],route[1]);
      ctx.fillStyle='#000'; ctx.strokeStyle='#FFF'; ctx.lineWidth=2;
      route.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x,p.y,10,0,2*Math.PI); ctx.fill(); ctx.stroke(); });
      dropmap.points.forEach(p=>{ ctx.fillStyle='yellow'; ctx.strokeStyle='black'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(p.x,p.y,6,0,2*Math.PI); ctx.fill(); ctx.stroke(); });
      if(bestLine){ const {best,bestDrop}=bestLine; ctx.fillStyle='cyan'; ctx.strokeStyle='cyan'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(best.x,best.y,8,0,2*Math.PI); ctx.fill(); ctx.setLineDash([5,5]); ctx.beginPath(); ctx.moveTo(best.x,best.y); ctx.lineTo(bestDrop.x,bestDrop.y); ctx.stroke(); ctx.setLineDash([]); }
    }

    function calculateDrops(){ if(!dropmap.points.length)return; const dx=route[1].x-route[0].x, dy=route[1].y-route[0].y, len=Math.hypot(dx,dy), ux=dx/len, uy=dy/len;
      let bestDist=Infinity, best=null, bestDrop=null;
      dropmap.points.forEach(p=>{ const px=p.x-route[0].x, py=p.y-route[0].y, proj=px*ux+py*uy;
        const projP={x:route[0].x+ux*proj,y:route[0].y+uy*proj}, dist=Math.hypot(projP.x-p.x,projP.y-p.y);
        if(dist<bestDist){ bestDist=dist; best=projP; bestDrop=p; }});
      bestLine={best,bestDrop}; draw(); }

    function resetRoute(){ route[0]={x:150,y:150}; route[1]={x:750,y:750}; bestLine=null; draw(); }
  </script>
</body>
</html>
