<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Busroute ziehen und Drop berechnen</title>
  <style>
    body { margin:0; background:#111; color:white; font-family:sans-serif; overflow:hidden; }
    #mapContainer { position: relative; width:100vw; height:100vh; }
    canvas { display:block; width:100%; height:100%; cursor:grab; }
    .controls {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 200;
    }
    button {
      padding: 12px 24px;
      border-radius: 30px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header {
      position: fixed;
      top: 10px;
      left: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 200;
    }
    .user-info {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      z-index: 200;
    }
    .user-info img { width:32px; height:32px; border-radius:50%; }
    .user-dropdown {
      position: absolute;
      top: 40px;
      right: 0;
      background: #222;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    .user-dropdown button {
      background: #dc3545;
      padding: 8px 12px;
      border-radius: 0;
      width: 100%;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="index.html" style="display:flex;align-items:center;text-decoration:none;color:white;">
      <img src="assets/dropmap.png" alt="Dropmap" width="32" height="32">
      <span style="font-weight:bold;font-size:18px;">Home</span>
    </a>
  </div>

  <div class="user-info" id="userInfo">
    <img src="assets/discord.png" id="userAvatar" alt="Avatar">
    <span id="userName">Gast</span>
    <div class="user-dropdown" id="userDropdown">
      <button id="logoutBtn">Ausloggen</button>
    </div>
  </div>

  <h2 style="position:fixed;top:50px;left:50%;transform:translateX(-50%);z-index:200;">Busroute ziehen und Drop berechnen</h2>

  <div class="controls">
    <button onclick="calculateDrops()">ðŸŽ¯ FIND BEST DROP</button>
    <button onclick="resetRoute()">ðŸ”„ Reset</button>
  </div>

  <div id="mapContainer">
    <canvas id="mapCanvas" width="900" height="900"></canvas>
  </div>

  <script>
    // User info
    const userInfo = JSON.parse(localStorage.getItem('user')||'{}');
    const avatarEl = document.getElementById('userAvatar');
    const nameEl = document.getElementById('userName');
    if(userInfo.username) {
      nameEl.textContent = userInfo.username;
      avatarEl.src = userInfo.avatarURL;
    }
    const ui = document.getElementById('userInfo');
    const ud = document.getElementById('userDropdown');
    ui.addEventListener('mouseenter',()=>ud.style.display='flex');
    ui.addEventListener('mouseleave',()=>ud.style.display='none');
    document.getElementById('logoutBtn').onclick = ()=>{
      localStorage.removeItem('user');
      window.location.href='index.html';
    };

    // Canvas & map
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    const img = new Image(); img.src='assets/map.png'; img.onerror=()=>alert('Fehler: Karte nicht geladen');
    const dropmaps = JSON.parse(localStorage.getItem('dropmaps')||'[]');
    const idx = +localStorage.getItem('editingDropmapIndex');
    const dropmap = dropmaps[idx]||{points:[]};
    let scale=1, ox=0, oy=0, drag=null, offX=0, offY=0;
    const route=[{x:150,y:150},{x:750,y:750}]; let bestLine=null;
    img.onload=draw;
    canvas.addEventListener('wheel',e=>{e.preventDefault();const d=e.deltaY>0?-0.1:0.1;const mx=(e.offsetX-ox)/scale,my=(e.offsetY-oy)/scale;scale=Math.min(Math.max(0.5,scale+d),3);ox=e.offsetX-mx*scale;oy=e.offsetY-my*scale;draw();});
    canvas.addEventListener('mousedown',e=>{const x=(e.offsetX-ox)/scale, y=(e.offsetY-oy)/scale; drag='map'; offX=e.clientX-ox; offY=e.clientY-oy; route.forEach((p,i)=>{if(Math.hypot(p.x-x,p.y-y)<12){drag=i;offX=p.x-x;offY=p.y-y;}});});
    canvas.addEventListener('mousemove',e=>{if(drag===null) return; if(drag==='map'){ox=e.clientX-offX; oy=e.clientY-offY;draw();} else {const rect=canvas.getBoundingClientRect();const x=(e.clientX-rect.left-ox)/scale,y=(e.clientY-rect.top-oy)/scale;route[drag]={x:x+offX,y:y+offY}; draw();}});
    canvas.addEventListener('mouseup',()=>drag=null);

    function drawArrow(start,end){const dx=end.x-start.x, dy=end.y-start.y, len=Math.hypot(dx,dy), steps=Math.floor(len/30), ang=Math.atan2(dy,dx);for(let i=0;i<steps;i++){const x=start.x+dx*(i/steps),y=start.y+dy*(i/steps);ctx.save();ctx.translate(x,y);ctx.rotate(ang);ctx.beginPath();ctx.moveTo(-5,-5);ctx.lineTo(5,0);ctx.lineTo(-5,5);ctx.closePath();ctx.fillStyle='#fff';ctx.fill();ctx.restore();}}    
    function draw(){canvas.width=900;canvas.height=900;ctx.setTransform(scale,0,0,scale,ox,oy);ctx.clearRect(0,0,900,900);ctx.drawImage(img,0,0,900,900);drawArrow(route[0],route[1]);route.forEach(p=>{ctx.fillStyle='#000';ctx.beginPath();ctx.arc(p.x,p.y,10,0,2*Math.PI);ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();});dropmap.points.forEach(p=>{ctx.fillStyle='yellow';ctx.beginPath();ctx.arc(p.x,p.y,6,0,2*Math.PI);ctx.fill();ctx.strokeStyle='black';ctx.lineWidth=2;ctx.stroke();});if(bestLine){ctx.fillStyle='cyan';ctx.beginPath();ctx.arc(bestLine.best.x,bestLine.best.y,8,0,2*Math.PI);ctx.fill();ctx.stroke();ctx.strokeStyle='cyan';ctx.setLineDash([5,5]);ctx.beginPath();ctx.moveTo(bestLine.best.x,bestLine.best.y);ctx.lineTo(bestLine.drop.x,bestLine.drop.y);ctx.stroke();ctx.setLineDash([]);} }

    function resetRoute(){route[0]={x:150,y:150};route[1]={x:750,y:750};bestLine=null;draw();}
    function calculateDrops(){if(!dropmap.points||!dropmap.points.length){alert('Keine Drops vorhanden.');return;}const dx=route[1].x-route[0].x,dy=route[1].y-route[0].y,len=Math.hypot(dx,dy),ux=dx/len,uy=dy/len;let bestDist=Infinity,best=null,drop=null;dropmap.points.forEach(p=>{const px=p.x-route[0].x,py=p.y-route[0].y,proj=px*ux+py*uy,projPoint={x:route[0].x+ux*proj,y:route[0].y+uy*proj},dist=Math.hypot(projPoint.x-p.x,projPoint.y-p.y);if(dist<bestDist){bestDist=dist;best=projPoint;drop=p;}});if(best){bestLine={best,drop};draw();}}
  </script>
</body>
</html>
