<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Busroute ziehen und Drop berechnen</title>
  <style>
    body { margin: 0; background: #111; color: white; font-family: sans-serif; overflow: hidden; }
    h2 { margin-top: 60px; text-align: center; }
    /* Home link */
    .home-link {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      align-items: center;
      text-decoration: none;
      color: white;
      z-index: 1000;
    }
    .home-link img { width: 32px; height: 32px; border-radius: 4px; }
    .home-link .home-text { font-weight: bold; font-size: 18px; margin-left: 8px; }

    /* User block */
    #userBlock {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 1000;
    }
    #userAvatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    #userName { font-size: 16px; }
    #logoutMenu {
      display: none;
      position: absolute;
      top: 110%; right: 0;
      background: #222;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    #logoutMenu button {
      display: block;
      width: 100%;
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    #logoutMenu button:hover { background: #c32; }

    /* Map Container */
    #mapContainer {
      position: relative;
      width: 900px;
      height: 900px;
      max-width: 95vw;
      max-height: 85vh;
      margin: 80px auto 20px;
      overflow: hidden;
    }
    canvas { display: block; cursor: grab; }

    /* Controls below map */
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 40px;
      justify-content: center;
    }
    .controls button {
      padding: 10px 20px;
      border-radius: 30px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <!-- Home -->
  <a class="home-link" href="index.html">
    <img src="fortnite-dropmap/assets/dropmap.png" alt="Dropmap">
    <span class="home-text">Home</span>
  </a>
  <!-- User -->
  <div id="userBlock">
    <img id="userAvatar" src="fortnite-dropmap/assets/discord.png" alt="Avatar">
    <span id="userName">Gast</span>
    <div id="logoutMenu"><button onclick="logout()">Log out</button></div>
  </div>

  <h2>Busroute ziehen und Drop berechnen</h2>

  <div id="mapContainer">
    <canvas id="mapCanvas" width="900" height="900"></canvas>
  </div>

  <div class="controls">
    <button onclick="calculateDrops()">ðŸŽ¯Â FIND BEST DROP</button>
    <button onclick="resetRoute()">ðŸ”„ Reset</button>
  </div>

  <script>
    // User block logic
    document.addEventListener('DOMContentLoaded', () => {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (user.username) {
        document.getElementById('userName').textContent = user.username;
        document.getElementById('userAvatar').src = user.avatarUrl;
      }
      const block = document.getElementById('userBlock');
      const menu = document.getElementById('logoutMenu');
      block.addEventListener('mouseenter', () => menu.style.display = 'block');
      block.addEventListener('mouseleave', () => menu.style.display = 'none');
    });
    function logout() { localStorage.removeItem('user'); window.location = 'index.html'; }

    // Map & route logic
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    img.src = 'fortnite-dropmap/assets/map.png';
    img.onerror = () => alert('Fehler: Karte konnte nicht geladen werden.');

    const dropmaps = JSON.parse(localStorage.getItem('dropmaps') || '[]');
    const editingIndex = parseInt(localStorage.getItem('editingDropmapIndex'));
    const dropmap = dropmaps[editingIndex] || {points:[]};
    dropmap.points = dropmap.points || [];

    // Default bus route
    const route = [{ x: 150, y: 150 }, { x: 750, y: 750 }];

    let scale = 1, ox = 0, oy = 0;
    let dragging = null, dragStart = null, offX, offY;
    let bestDropLine = null;

    img.onload = () => draw();

    canvas.addEventListener('wheel', e => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      const mx = (e.offsetX - ox) / scale, my = (e.offsetY - oy) / scale;
      scale = Math.min(Math.max(0.5, scale + delta), 3);
      ox = e.offsetX - mx * scale; oy = e.offsetY - my * scale;
      draw();
    });

    canvas.addEventListener('mousedown', e => {
      const x = (e.offsetX - ox) / scale;
      const y = (e.offsetY - oy) / scale;
      dragStart = { x: e.clientX, y: e.clientY };
      offX = e.clientX - ox; offY = e.clientY - oy;
      dragging = 'map';
      route.forEach((pt, i) => {
        if (Math.hypot(pt.x - x, pt.y - y) < 12) dragging = i;
      });
    });
    canvas.addEventListener('mousemove', e => {
      if (!dragStart) return;
      const dx = e.clientX - dragStart.x, dy = e.clientY - dragStart.y;
      if (dragging === 'map' && Math.hypot(dx, dy) > 2) {
        ox = e.clientX - offX; oy = e.clientY - offY;
      } else if (typeof dragging === 'number') {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left - ox) / scale;
        const y = (e.clientY - rect.top - oy) / scale;
        route[dragging] = { x: x, y: y };
      }
      draw();
    });
    canvas.addEventListener('mouseup', () => dragStart = null);

    function drawArrow(start, end) {
      const dx = end.x - start.x, dy = end.y - start.y;
      const len = Math.hypot(dx, dy), steps = Math.floor(len/30);
      const ang = Math.atan2(dy, dx);
      for (let i=0;i<steps;i++) {
        const x = start.x + dx*(i/steps), y = start.y + dy*(i/steps);
        ctx.save(); ctx.translate(x,y); ctx.rotate(ang);
        ctx.beginPath(); ctx.moveTo(-5,-5); ctx.lineTo(5,0); ctx.lineTo(-5,5);
        ctx.fillStyle = '#fff'; ctx.fill(); ctx.restore();
      }
    }

    function draw() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
      ctx.setTransform(scale,0,0,scale,ox,oy);
      ctx.clearRect(0,0,900,900);
      ctx.drawImage(img,0,0,900,900);
      // route arrows
      drawArrow(route[0], route[1]);
      // route endpoints
      route.forEach(p => {
        ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(p.x,p.y,10,0,2*Math.PI); ctx.fill();
        ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.stroke();
      });
      // drops
      dropmap.points.forEach(p=>{
        ctx.fillStyle='yellow'; ctx.beginPath(); ctx.arc(p.x,p.y,6,0,2*Math.PI); ctx.fill();
        ctx.strokeStyle='black'; ctx.lineWidth=2; ctx.stroke();
      });
      // best drop
      if (bestDropLine) {
        const {best,bestDrop} = bestDropLine;
        ctx.fillStyle='cyan'; ctx.beginPath(); ctx.arc(best.x,best.y,8,0,2*Math.PI); ctx.fill();
        ctx.strokeStyle='cyan'; ctx.setLineDash([5,5]);
        ctx.beginPath(); ctx.moveTo(best.x,best.y); ctx.lineTo(bestDrop.x,bestDrop.y); ctx.stroke();
        ctx.setLineDash([]);
      }
    }

    function calculateDrops() {
      if (!dropmap.points.length) return;
      const dx = route[1].x - route[0].x, dy = route[1].y - route[0].y;
      const len = Math.hypot(dx,dy), ux = dx/len, uy = dy/len;
      let bestDist=Infinity, best=null, drop=null;
      dropmap.points.forEach(p=>{
        const px=p.x-route[0].x, py=p.y-route[0].y;
        const proj = px*ux+py*uy;
        const projP = { x: route[0].x+ux*proj, y: route[0].y+uy*proj };
        const dist=Math.hypot(projP.x-p.x,projP.y-p.y);
        if (dist<bestDist) { bestDist=dist; best=projP; drop=p; }
      });
      if (best) { bestDropLine={best,bestDrop:drop}; draw(); }
    }
    function resetRoute() { route[0]={x:150,y:150}; route[1]={x:750,y:750}; bestDropLine=null; draw(); }
  </script>
</body>
</html>
