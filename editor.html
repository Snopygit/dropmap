<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Dropmap bearbeiten</title>
  <style>
    body { margin: 0; background: #111; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
    #toolbar { margin: 10px; display: flex; gap: 10px; }
    #markerIcon { font-size: 24px; cursor: grab; }
    #mapContainer { position: relative; }
    canvas { border: 2px solid #333; border-radius: 10px; cursor: grab; }
    .marker { position: absolute; width: 16px; height: 16px; background: yellow; border: 2px solid black; border-radius: 50%; transform: translate(-50%, -50%); cursor: pointer; }
    .context-menu { position: absolute; background: #222; padding: 8px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.5); display: none; z-index: 1000; }
    .context-menu button { display: block; width: 100%; background: none; color: white; border: none; padding: 4px 8px; text-align: left; cursor: pointer; }
    .popup, .overlay { /* unchanged popup code... */ }
  </style>
</head>
<body>
  <h2>Dropmap bearbeiten</h2>
  <div id="toolbar">
    <div id="markerIcon" draggable="true">📍</div>
    <button onclick="undo()">↩️</button>
    <button onclick="redo()">↪️</button>
    <button onclick="showPopup()">💾</button>
  </div>
  <div id="mapContainer">
    <canvas id="mapCanvas" width="900" height="900"></canvas>
  </div>

  <div class="context-menu" id="contextMenu">
    <button onclick="startEdit()">✏️ Bearbeiten</button>
    <button onclick="deleteMarker()">🗑️ Löschen</button>
  </div>
  <!-- popup & overlay here -->

  <script>
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    const mapContainer = document.getElementById('mapContainer');
    const markerIcon = document.getElementById('markerIcon');
    const contextMenu = document.getElementById('contextMenu');
    let markers = [];
    let editingMarker = null;

    // Drag & drop from toolbar
    markerIcon.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain','marker'));
    mapContainer.addEventListener('dragover', e => e.preventDefault());
    mapContainer.addEventListener('drop', e => {
      e.preventDefault();
      if (e.dataTransfer.getData('text/plain')==='marker') {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        addMarker(x, y);
      }
    });

    function addMarker(x, y) {
      const el = document.createElement('div');
      el.className = 'marker';
      el.style.left = x+'px';
      el.style.top = y+'px';
      el.addEventListener('click', e=>{
        e.stopPropagation();
        showContextMenu(e.clientX, e.clientY, el);
      });
      mapContainer.appendChild(el);
      markers.push(el);
    }

    function showContextMenu(cx, cy, marker) {
      editingMarker = marker;
      contextMenu.style.left = cx+'px';
      contextMenu.style.top = cy+'px';
      contextMenu.style.display = 'block';
    }
    document.body.addEventListener('click', ()=>contextMenu.style.display='none');

    function startEdit() {
      contextMenu.style.display='none';
      const m = editingMarker;
      m.setAttribute('draggable','true');
      m.addEventListener('dragstart', dragMarkerStart);
      m.addEventListener('dragend', dragMarkerEnd);
    }
    function dragMarkerStart(e) {
      e.dataTransfer.setData('text/marker', '');
      editingMarker = e.target;
    }
    function dragMarkerEnd(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      editingMarker.style.left = x+'px';
      editingMarker.style.top = y+'px';
      editingMarker.removeAttribute('draggable');
      editingMarker.removeEventListener('dragstart', dragMarkerStart);
      editingMarker.removeEventListener('dragend', dragMarkerEnd);
    }
    mapContainer.addEventListener('dragover', e=>e.preventDefault());
    mapContainer.addEventListener('drop', e=>{
      if (e.dataTransfer.types.includes('text/marker')) {
        dragMarkerEnd(e);
      }
    });

    function deleteMarker() {
      editingMarker.remove();
      contextMenu.style.display='none';
    }

    // Undo/redo stubs...
    function undo(){/*...*/} function redo(){/*...*/}

    // Popup code...
  </script>
</body>
</html>
