<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Dropmap bearbeiten</title>
  <style>
    body { margin: 0; background: #111; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
    body.no-scroll { overflow: hidden; }

    /* Home-Link */
    .home {
      position: fixed; top: 10px; left: 10px;
      display: flex; align-items: center; gap: 10px; z-index: 1000;
    }
    .home img { width: 32px; height: 32px; border-radius: 4px; }
    .home h1 { margin: 0; font-size: 24px; color: white; }

    /* User‚ÄëPanel */
    .user-panel {
      position: fixed; top: 10px; right: 10px;
      display: none; align-items: center; gap: 8px;
      background: #222; padding: 8px 12px; border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.5); z-index: 1000;
    }
    .user-panel img { width: 32px; height: 32px; border-radius: 50%; }
    .user-panel .name { color: white; font-weight: bold; cursor: pointer; position: relative; }
    .logout-menu { position: absolute; top: 110%; right: 0; background: #222; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.5); display: none; opacity: 0; transition: opacity 0.3s ease; }
    .logout-menu button { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .user-panel:hover .logout-menu,
    .logout-menu:hover { display: block; opacity: 1; }

    h2 { margin: 60px 0 10px; }

    .controls { margin-bottom: 10px; }
    .controls button { background: #007bff; border: none; color: white; padding: 10px 20px; border-radius: 8px; font-size: 16px; cursor: pointer; }

    #mapContainer { position: relative; }
    canvas { border: 2px solid #333; border-radius: 10px; cursor: grab; display: block; }

    /* Not‚Äëwhitelisted Popup */
    #overlayPopup { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); display: none; z-index: 2000; }
    #notWhitePopup {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
      background: #2C2F33; padding: 30px 20px; border-radius: 12px;
      box-shadow: 0 0 20px 5px #7289DA; display: none;
      flex-direction: column; align-items: center;
      z-index: 2001; opacity: 0; transition: opacity 0.3s ease;
    }
    #notWhitePopup p { margin: 0 0 20px; font-size: 18px; font-weight: bold; text-align: center; }
    #notWhitePopup button { background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; }

  </style>
</head>
<body>
  <div class="home">
    <a href="index.html">
      <img src="fortnite-dropmap/assets/dropmap.png" alt="Dropmap">
      <h1>Home</h1>
    </a>
  </div>

  <!-- Discord‚ÄëPanel -->
  <div class="user-panel" id="userPanel">
    <img id="userAvatar" src="" alt="Avatar">
    <div class="name" id="userName"></div>
    <div class="logout-menu" id="logoutMenu">
      <button onclick="logout()">üö™¬†Logout</button>
    </div>
  </div>

  <h2>Dropmap bearbeiten</h2>
  <div class="controls">
    <button onclick="showPopup()">üíæ¬†Dropmap speichern</button>
  </div>
  <div id="mapContainer">
    <canvas id="mapCanvas" width="900" height="900"></canvas>
    <div class="context-menu" id="contextMenu">
      <button onclick="enableEdit()">‚úèÔ∏è¬†Bearbeiten</button>
      <button onclick="deleteMarker()">üóëÔ∏è¬†L√∂schen</button>
    </div>
    <div class="side-controls">
      <button id="markerIcon" class="icon-button" draggable="true">üìç</button>
      <button class="icon-button" onclick="undo()">‚Ü©Ô∏è</button>
      <button class="icon-button" onclick="redo()">‚Ü™Ô∏è</button>
    </div>
  </div>

  <div id="overlayPopup"></div>
  <div id="notWhitePopup">
    <p>Du bist nicht whitelisted!</p>
    <button onclick="logout()">Log mich aus</button>
  </div>

  <div class="overlay" id="overlay" onclick="hidePopup(event)"></div>
  <div class="popup" id="popup">
    <button class="close-btn" onclick="closePopup()">‚úñ</button>
    <label for="dropmapName">Name der Dropmap:</label>
    <input type="text" id="dropmapName" placeholder="z.B. Meine Dropmap">
    <button class="save-button" onclick="saveDropmapName()">Speichern</button>
  </div>

  <script>
    const whitelist = ['1221451449695735884','644602114256928789','868581285277347920'];
    async function fetchUser() {
      const token = localStorage.getItem('discord_token');
      if (!token) return showNotWhite();
      try {
        const res = await fetch('https://discord.com/api/users/@me', { headers:{'Authorization':'Bearer '+token}});
        if (!res.ok) throw 0;
        const u = await res.json();
        if (!whitelist.includes(u.id)) return showNotWhite();
        document.getElementById('userName').textContent = `${u.username}#${u.discriminator}`;
        document.getElementById('userAvatar').src = `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png?size=64`;
        document.getElementById('userPanel').style.display = 'flex';
      } catch { localStorage.removeItem('discord_token'); showNotWhite(); }
    }
    function showNotWhite(){
      document.getElementById('overlayPopup').style.display = 'block';
      setTimeout(()=>{
        const p=document.getElementById('notWhitePopup');
        p.style.display='flex'; p.style.opacity=1;
      },10);
    }
    function logout(){ localStorage.removeItem('discord_token'); window.location='index.html'; }
    window.addEventListener('load',fetchUser);

    // --- map & editor code ---
    const canvas=document.getElementById('mapCanvas'),ctx=canvas.getContext('2d');
    const mapContainer=document.getElementById('mapContainer');
    const markerIcon=document.getElementById('markerIcon');
    const contextMenu=document.getElementById('contextMenu');
    const overlay=document.getElementById('overlay'),popup=document.getElementById('popup');
    let dropmaps=JSON.parse(localStorage.getItem('dropmaps')||'[]');
    let editingIndex=+localStorage.getItem('editingDropmapIndex');
    let dropmap=dropmaps[editingIndex]||{points:[]};dropmap.points=dropmap.points||[];
    const img=new Image();img.src='fortnite-dropmap/assets/map.png';img.onerror=()=>alert('Fehler: Karte konnte nicht geladen werden');

    let scale=1,ox=0,oy=0,dragStart=null,dragging=false;
    img.onload=draw;
    canvas.addEventListener('mousedown',e=>{dragStart={x:e.clientX,y:e.clientY};dragging=false;});
    canvas.addEventListener('mousemove',e=>{if(dragStart){const dx=e.clientX-dragStart.x,dy=e.clientY-dragStart.y;if(!dragging&&Math.hypot(dx,dy)>5)dragging=true;if(dragging){ox+=dx;oy+=dy;dragStart={x:e.clientX,y:e.clientY};draw();updateMarkers();updateContextMenu();}}});
    canvas.addEventListener('mouseup',()=>dragStart=null);
    canvas.addEventListener('wheel',e=>{e.preventDefault();const d=e.deltaY>0?-0.1:0.1,mx=(e.offsetX-ox)/scale,my=(e.offsetY-oy)/scale;scale=Math.min(Math.max(0.5,scale+d),3);ox=e.offsetX-mx*scale;oy=e.offsetY-my*scale;draw();updateMarkers();updateContextMenu();});
    function draw(){canvas.width=900;canvas.height=900;ctx.setTransform(scale,0,0,scale,ox,oy);ctx.clearRect(0,0,900,900);ctx.drawImage(img,0,0,900,900);}    
    function updateMarkers(){document.querySelectorAll('.marker').forEach((el,i)=>{const p=dropmap.points[i];el.style.left=(ox+p.x*scale)+'px';el.style.top=(oy+p.y*scale)+'px';});}
    function updateContextMenu(){if(contextMenu.style.display==='block'&&editingEl){const cr=mapContainer.getBoundingClientRect(),mr=editingEl.getBoundingClientRect(),menr=contextMenu.getBoundingClientRect();const left=mr.left+mr.width/2-menr.width/2-cr.left;const top=mr.top-menr.height-8-cr.top;contextMenu.style.left=left+'px';contextMenu.style.top=top+'px';}}
    markerIcon.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain','newMarker'));
    mapContainer.addEventListener('dragstart',e=>{if(e.target.classList.contains('marker')&&e.target.draggable){const idx=e.target.dataset.idx;e.dataTransfer.setData('text/plain','edit:'+idx);}});
    mapContainer.addEventListener('dragover',e=>e.preventDefault());
    mapContainer.addEventListener('drop',e=>{e.preventDefault();const data=e.dataTransfer.getData('text/plain'),rect=canvas.getBoundingClientRect(),x=e.clientX-rect.left,y=e.clientY-rect.top;if(data==='newMarker'){addMarker(x,y);}else if(data.startsWith('edit:')){const i=+data.split(':')[1],mx=(x-ox)/scale,my=(y-oy)/scale;dropmap.points[i]={x:mx,y:my};updateMarkers();updateContextMenu();}});
    function addMarker(x,y){const mx=(x-ox)/scale,my=(y-oy)/scale;dropmap.points.push({x:mx,y:my});renderMarker(dropmap.points.length-1);}    
    function renderMarker(idx){const el=document.createElement('div');el.className='marker';el.dataset.idx=idx;el.draggable=false;el.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain','edit:'+idx));el.addEventListener('click',e=>{e.stopPropagation();showContextMenu(e.clientX,e.clientY,el);});mapContainer.appendChild(el);updateMarkers();}
    dropmap.points.forEach((_,i)=>renderMarker(i));
    let editingEl=null;function showContextMenu(x,y,el){editingEl=el;updateContextMenu();contextMenu.style.display='block';}
    document.body.addEventListener('click',e=>{if(contextMenu.style.display==='block'&&!contextMenu.contains(e.target))contextMenu.style.display='none';});
    function enableEdit(){contextMenu.style.display='none';editingEl.draggable=true;updateContextMenu();}
    function deleteMarker(){const i=+editingEl.dataset.idx;dropmap.points.splice(i,1);mapContainer.removeChild(editingEl);document.querySelectorAll('.marker').forEach((m,j)=>m.dataset.idx=j);updateMarkers();contextMenu.style.display='none';}
    function undo(){}
    function redo(){}
    function showPopup(){document.body.classList.add('no-scroll');overlay.style.display='block';popup.style.display='flex';popup.style.opacity='0';setTimeout(()=>popup.style.opacity='1',10);}
    function hidePopup(e){if(e.target===overlay)closePopup();}
    function closePopup(){popup.style.opacity='0';overlay.style.opacity='0';setTimeout(()=>{popup.style.display='none';overlay.style.display='none';document.body.classList.remove('no-scroll');},300);}
    function saveDropmapName(){const inp=document.getElementById('dropmapName'),v=inp.value.trim(),old=!!dropmap.name;if(v)dropmap.name=v;else if(!old)dropmap.name='Neue Dropmap';dropmaps[editingIndex]=dropmap;localStorage.setItem('dropmaps',JSON.stringify(dropmaps));window.location='index.html';}
  </script>
</body>
</html>
