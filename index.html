<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Deine Dropmaps</title>
  <style>
    body { margin: 0; background: #111; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
    body.no-scroll { overflow: hidden; }
    .header { display: flex; align-items: center; gap: 20px; position: absolute; top: 10px; left: 10px; z-index: 1000; }
    .user-panel { position: absolute; top: 10px; right: 10px; display: flex; align-items: center; gap: 8px; background: #222; padding: 5px 10px; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.5); z-index: 1000; }
    .user-panel img { width: 32px; height: 32px; border-radius: 50%; }
    .user-panel .name { position: relative; cursor: pointer; }
    .logout-menu { position: absolute; top: 100%; right: 0; background: #222; padding: 8px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.5); display: none; opacity: 0; transition: opacity 0.3s ease; }
    .logout-menu button { background: #dc3545; border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .user-panel:hover .logout-menu {
      display: block;
      opacity: 1;
    }
    .dropmap-list { margin-top: 80px; display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; }
    .dropmap-card { background: #222; border-radius: 10px; padding: 10px; text-align: center; width: 200px; }
    .dropmap-card img { width: 100%; border-radius: 8px; margin-bottom: 8px; }
    .dropmap-card p { margin: 0 0 10px; }
    .dropmap-card button { margin: 5px 0; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 8px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color: white; }
    .dropmap-card button.primary-action { background: #007bff; }
    .dropmap-card button.calculate-action { background: #007bff; }
    .dropmap-card button.delete-button { background: #dc3545; }
    button.create-new { margin-top: 20px; padding: 10px 20px; background: #007bff; border: none; border-radius: 5px; color: white; font-weight: bold; display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); display: none; z-index: 999; }
    .login-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2C2F33; padding: 30px 20px 20px; border-radius: 10px; box-shadow: 0 0 20px 5px #7289DA; display: none; flex-direction: column; align-items: center; z-index: 1000; transition: opacity 0.3s ease; }
    .login-popup img { width: 64px; height: 64px; margin-bottom: 16px; }
    .login-popup button { background: #7289DA; border: none; color: white; padding: 10px 16px; font-size: 16px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .login-popup .close-btn { position: absolute; top: 8px; right: 10px; background: transparent; font-size: 18px; color: white; border: none; cursor: pointer; }
    .confirm-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; padding: 40px 20px 20px; border-radius: 20px; box-shadow: 0 0 20px 5px yellow; display: none; flex-direction: column; align-items: center; z-index: 1000; transition: opacity 0.3s ease; }
    .confirm-popup p { margin: 0 0 20px; }
    .confirm-popup .close-btn { position: absolute; top: 8px; right: 10px; background: transparent; font-size: 18px; color: white; border: none; cursor: pointer; }
    .confirm-popup button { padding: 10px 20px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; }
    .confirm-popup .delete-button { background: #dc3545; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <img src="assets/dropmap.png" alt="Dropmap" width="32" height="32">
    <h1>Deine Dropmaps</h1>
  </div>

  <!-- User Info Panel -->
  <div class="user-panel" id="userPanel" style="display:none;">
    <img id="userAvatar" src="" alt="Avatar">
    <div class="name" id="userName"></div>
    <div class="logout-menu" id="logoutMenu">
      <button onclick="logout()">üö™ Logout</button>
    </div>
  </div>

  <!-- Dropmap List -->
  <div class="dropmap-list" id="dropmapList"></div>
  <button class="create-new" onclick="createNewDropmap()">‚ûï Neue Dropmap</button>

  <!-- Login Popup -->
  <div class="overlay" id="loginOverlay"></div>
  <div class="login-popup" id="loginPopup">
    <button class="close-btn" onclick="closeLogin()">‚úñ</button>
    <img src="assets/discord.png" alt="Discord Login">
    <button onclick="loginDiscord()">üéÆ Login mit Discord</button>
  </div>

  <!-- Delete Confirmation Popup -->
  <div class="overlay" id="deleteOverlay"></div>
  <div class="confirm-popup" id="deletePopup">
    <button class="close-btn" onclick="closeDelete(event)">‚úñ</button>
    <p>Diese Dropmap wirklich l√∂schen?</p>
    <button class="delete-button" onclick="confirmDelete()">üóëÔ∏è L√∂schen</button>
  </div>

  <script>
    // ---- Token & User Fetch ----
    const token = localStorage.getItem('discord_token');
    async function fetchUser() {
      if (!token) return;
      try {
        const res = await fetch('https://discord.com/api/users/@me', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error();
        const user = await res.json();
        const panel = document.getElementById('userPanel');
        const avatar = document.getElementById('userAvatar');
        const nameEl = document.getElementById('userName');
        avatar.src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=64`;
        nameEl.textContent = `${user.username}#${user.discriminator}`;
        panel.style.display = 'flex';
      } catch {
        localStorage.removeItem('discord_token');
        showLogin();
      }
    }

    // ---- Logout ----
    function logout() {
      localStorage.removeItem('discord_token');
      window.location.reload();
    }

    // ---- Login Logic (Implicit Grant) ----
    const loginOverlay = document.getElementById('loginOverlay');
    const loginPopup = document.getElementById('loginPopup');
    window.onload = async () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      if (params.has('access_token')) {
        localStorage.setItem('discord_token', params.get('access_token'));
        history.replaceState(null, '', window.location.pathname);
      }
      if (localStorage.getItem('discord_token')) {
        closeLogin();
        await fetchUser();
      } else {
        showLogin();
      }
    };

    function showLogin() {
      document.body.classList.add('no-scroll');
      loginOverlay.style.display = 'block';
      loginPopup.style.display = 'flex';
      loginPopup.style.opacity = '0';
      setTimeout(() => loginPopup.style.opacity = '1', 10);
    }
    function closeLogin() {
      loginPopup.style.opacity = '0';
      loginOverlay.style.opacity = '0';
      setTimeout(() => {
        loginPopup.style.display = 'none';
        loginOverlay.style.display = 'none';
        document.body.classList.remove('no-scroll');
      }, 300);
    }
    function loginDiscord() {
      const redirectUri = encodeURIComponent('https://snopygit.github.io/dropmap/');
      window.location.href = `https://discord.com/oauth2/authorize?client_id=1362743453066203186&response_type=token&redirect_uri=${redirectUri}&scope=identify%20email`;
    }

    // ---- Dropmap Management ----
    const container = document.getElementById('dropmapList');
    let dropmaps = JSON.parse(localStorage.getItem('dropmaps') || '[]');
    let deleteIndex = null;

    function renderDropmaps() {
      container.innerHTML = '';
      dropmaps.forEach((map, idx) => {
        const card = document.createElement('div');
        card.className = 'dropmap-card';
        card.innerHTML = `
          <img src="assets/map.png" alt="Vorschau">
          <p>${map.name || 'Unbenannt'}</p>
          <button class="primary-action" onclick="editDropmap(${idx})">üñäÔ∏è Bearbeiten</button>
          <button class="calculate-action" onclick="calculateDrop(${idx})">üéØ Calculate Drop</button>
          <button class="delete-button" onclick="showDelete(${idx})">üóëÔ∏è L√∂schen</button>
        `;
        container.appendChild(card);
      });
    }
    function createNewDropmap() {
      dropmaps.push({ name: 'Neue Dropmap', points: [] });
      localStorage.setItem('dropmaps', JSON.stringify(dropmaps));
      localStorage.setItem('editingDropmapIndex', dropmaps.length - 1);
      window.location.href = 'editor.html';
    }
    function editDropmap(i) {
      localStorage.setItem('editingDropmapIndex', i);
      window.location.href = 'editor.html';
    }
    function calculateDrop(i) {
      localStorage.setItem('editingDropmapIndex', i);
      window.location.href = 'calculate.html';
    }

    // ---- Delete Confirmation ----
    const deleteOverlay = document.getElementById('deleteOverlay');
    const deletePopup = document.getElementById('deletePopup');
    function showDelete(i) {
      deleteIndex = i;
      document.body.classList.add('no-scroll');
      deleteOverlay.style.display = 'block';
      deletePopup.style.display = 'flex';
      deletePopup.style.opacity = '0';
      setTimeout(() => deletePopup.style.opacity = '1', 10);
    }
    function closeDelete(e) {
      if (e && e.target.id !== 'deleteOverlay') return;
      deletePopup.style.opacity = '0';
      deleteOverlay.style.opacity = '0';
      setTimeout(() => {
        deletePopup.style.display = 'none';
        deleteOverlay.style.display = 'none';
        document.body.classList.remove('no-scroll');
      }, 300);
    }
    function confirmDelete() {
      dropmaps.splice(deleteIndex, 1);
      localStorage.setItem('dropmaps', JSON.stringify(dropmaps));
      closeDelete();
      renderDropmaps();
    }

    // Initial render
    renderDropmaps();
  </script>
</body>
</html>
